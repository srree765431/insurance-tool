<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ä¿éšªåˆ†æåŠ©ç†ç³»çµ± (Powered by Gemini)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PDF.js for PDF Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        window.setupPdfWorker = function() {
            if (window.pdfjsLib && !window.pdfjsLib.GlobalWorkerOptions.workerSrc) {
                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
        }
    </script>

    <!-- Markdown Parser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>

    <!-- SheetJS for Excel Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f4f8; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Chat Bubble Styles */
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 16px; margin-bottom: 12px; line-height: 1.6; font-size: 0.95rem; position: relative; }
        .chat-user { background-color: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-ai { background-color: #ffffff; color: #1f2937; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
        
        /* Markdown Styles */
        .prose h1, .prose h2, .prose h3 { margin-top: 1em; margin-bottom: 0.5em; font-weight: 700; color: #1e3a8a; }
        .prose h2 { font-size: 1.25em; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.3em; }
        .prose ul { list-style-type: none; padding-left: 0; margin: 0.5em 0; }
        .prose li { padding-left: 1.2em; position: relative; margin-bottom: 0.3em; }
        .prose li::before { content: "â€¢"; color: #3b82f6; font-weight: bold; position: absolute; left: 0; }
        .prose strong { font-weight: 700; color: #b91c1c; }
        .prose p { margin-bottom: 0.8em; line-height: 1.7; }
        
        /* Table Styling */
        .prose table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 1em 0; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .prose th { background-color: #eff6ff; color: #1e40af; font-weight: 600; padding: 10px; text-align: left; border-bottom: 2px solid #dbeafe; }
        .prose td { padding: 10px; border-bottom: 1px solid #f1f5f9; background-color: white; }
        .prose tr:last-child td { border-bottom: none; }

        .typing-indicator span { display: inline-block; width: 6px; height: 6px; background-color: #9ca3af; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; margin: 0 2px; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const md = window.markdownit();

        // ============================================================================
        // â˜…â˜…â˜… å®‰å…¨è¨­å®šå€ (SECURITY ZONE) â˜…â˜…â˜…
        // 1. è‹¥æ‚¨è¦ä¸Šå‚³åˆ° GitHub (å…¬é–‹ç¶²å€)ï¼Œé€™è£¡å¿…é ˆæ˜¯ç©ºå­—ä¸² ""ã€‚
        // 2. åªè¦é€™è£¡æ˜¯ç©ºçš„ï¼ŒGoogle å°±ä¸æœƒé–æ‚¨çš„ Keyã€‚
        const PRE_CONFIGURED_API_KEY = ""; 
        // ============================================================================

        // --- ICONS ---
        const Icons = {
            Robot: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-600"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 3v18"/><path d="m14 9 3 3-3 3"/><path d="m9 9-3 3 3 3"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-400"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Key: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/><path d="M6.24 17.4a5.05 5.05 0 0 0 1.54-1.54"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            Calculator: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-500"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            Users: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-indigo-600"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-green-500"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Plan: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-emerald-600"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="M8 18v-1"/><path d="M16 18v-3"/></svg>,
            Warn: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-amber-500"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-slate-500"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        };

        // --- GEMINI API HANDLER ---
        const GeminiService = {
            generateContent: async (apiKey, prompt) => {
                if (!apiKey) throw new Error("è«‹å…ˆè¨­å®š API Key");
                
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }]
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || "API å‘¼å«å¤±æ•—");
                }

                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "ç„¡æ³•ç”¢ç”Ÿå›æ‡‰";
            }
        };

        // --- APP COMPONENT ---
        function App() {
            const [activeTab, setActiveTab] = useState('ai'); 
            const [apiKey, setApiKey] = useState(PRE_CONFIGURED_API_KEY || localStorage.getItem('gemini_api_key') || '');
            const [showSettings, setShowSettings] = useState(!apiKey && !PRE_CONFIGURED_API_KEY);

            const saveApiKey = (key) => {
                setApiKey(key);
                localStorage.setItem('gemini_api_key', key);
                setShowSettings(false);
            };

            useEffect(() => {
                if (window.setupPdfWorker) window.setupPdfWorker();
            }, []);

            return (
                <div className="min-h-screen flex flex-col bg-slate-50 font-sans text-slate-800">
                    {/* Navbar */}
                    <header className="bg-white shadow-sm sticky top-0 z-50">
                        <div className="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
                            <div className="flex items-center gap-2 text-blue-700">
                                <Icons.Robot />
                                <h1 className="font-bold text-lg tracking-tight">AI ä¿éšªåˆ†æåŠ©ç†</h1>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="hidden md:flex items-center gap-1 text-xs font-medium px-3 py-1 rounded-full bg-slate-100 text-slate-600 border border-slate-200">
                                    <Icons.Lock />
                                    {apiKey ? <span className="text-green-600">API é‡‘é‘°å·²å„²å­˜</span> : "API é‡‘é‘°æœªè¨­å®š"}
                                </div>
                                <button 
                                    onClick={() => setShowSettings(!showSettings)}
                                    className={`p-2 rounded-full transition-colors ${!apiKey ? 'bg-red-100 text-red-600 animate-pulse' : 'hover:bg-slate-100 text-slate-600'}`}
                                    title="è¨­å®š API Key"
                                >
                                    <Icons.Settings />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Desktop Navigation Tabs */}
                    <div className="hidden md:flex justify-center mt-6 mb-2">
                        <div className="bg-white p-1 rounded-xl shadow-sm border border-slate-200 flex gap-1">
                            <button 
                                onClick={() => setActiveTab('ai')}
                                className={`px-6 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'ai' ? 'bg-blue-100 text-blue-700 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}
                            >
                                <div className="flex items-center gap-2"><Icons.Robot /> DM åˆ†æ</div>
                            </button>
                            <button 
                                onClick={() => setActiveTab('smart_plan')}
                                className={`px-6 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'smart_plan' ? 'bg-blue-100 text-blue-700 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}
                            >
                                <div className="flex items-center gap-2"><Icons.Calculator /> å»ºè­°æ›¸è¦åŠƒ</div>
                            </button>
                        </div>
                    </div>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 fade-in">
                            <div className="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                    <Icons.Key /> è¨­å®š AI é‡‘é‘°
                                </h3>
                                <p className="text-sm text-slate-500 mb-4">
                                    æœ¬ç³»çµ±éœ€è¦ Google Gemini API Key æ‰èƒ½é‹ä½œã€‚<br/>
                                    é‡‘é‘°å°‡ç›´æ¥å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œ**ä¸æœƒ**ä¸Šå‚³åˆ°ä¼ºæœå™¨ã€‚
                                </p>
                                
                                <div className="bg-blue-50 border border-blue-100 p-3 rounded-lg mb-4 text-xs text-blue-800">
                                    <strong>å®‰å¿ƒæé†’ï¼š</strong> åªè¦è¼¸å…¥ä¸€æ¬¡ï¼Œä¸‹æ¬¡æ‰“é–‹ç¶²é æ™‚ç³»çµ±æœƒè‡ªå‹•è¨˜å¾—æ‚¨çš„ Keyï¼Œä¸éœ€é‡è¤‡è¼¸å…¥ã€‚
                                </div>

                                <input 
                                    type="password" 
                                    placeholder="è«‹è²¼ä¸Šæ‚¨çš„ Key (AIza...)" 
                                    className="w-full p-3 border border-slate-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
                                    defaultValue={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowSettings(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">é—œé–‰</button>
                                    <button onClick={() => saveApiKey(apiKey)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å„²å­˜ä¸¦å•Ÿç”¨</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <main className="flex-1 max-w-6xl mx-auto w-full p-4 pb-24 md:pb-6">
                        {activeTab === 'ai' ? (
                            <AIAssistant apiKey={apiKey} openSettings={() => setShowSettings(true)} />
                        ) : (
                            <SmartProposal apiKey={apiKey} />
                        )}
                    </main>

                    {/* Mobile Tab Bar */}
                    <div className="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 flex justify-around p-3 z-40">
                        <button onClick={() => setActiveTab('ai')} className={`flex flex-col items-center gap-1 text-xs ${activeTab === 'ai' ? 'text-blue-600 font-bold' : 'text-slate-400'}`}>
                            <Icons.Robot /> DM åˆ†æ
                        </button>
                        <button onClick={() => setActiveTab('smart_plan')} className={`flex flex-col items-center gap-1 text-xs ${activeTab === 'smart_plan' ? 'text-blue-600 font-bold' : 'text-slate-400'}`}>
                            <Icons.Calculator /> å»ºè­°æ›¸è¦åŠƒ
                        </button>
                    </div>
                </div>
            );
        }

        // --- FEATURE 1: AI ASSISTANT (Fixed FABs + Clean Script) ---
        function AIAssistant({ apiKey, openSettings }) {
            const [dmText, setDmText] = useState('');
            const [fileName, setFileName] = useState('');
            const [fabAnalysis, setFabAnalysis] = useState(null); 
            const [generatedScript, setGeneratedScript] = useState('');
            const [chatHistory, setChatHistory] = useState([]);
            const [userInput, setUserInput] = useState('');
            const [isProcessingFile, setIsProcessingFile] = useState(false);
            const [isGeneratingScript, setIsGeneratingScript] = useState(false);
            const [isChatLoading, setIsChatLoading] = useState(false);
            const [targetAudience, setTargetAudience] = useState('family');

            const fileInputRef = useRef(null);
            const chatEndRef = useRef(null);

            const scrollToBottom = () => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(scrollToBottom, [chatHistory]);

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setFileName(file.name);
                setIsProcessingFile(true);
                setDmText('');
                setFabAnalysis(null);
                setGeneratedScript('');
                setChatHistory([]); 

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = '';
                    const maxPages = Math.min(pdf.numPages, 12); 
                    for (let i = 1; i <= maxPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                    }
                    
                    fullText = fullText.replace(/[\x00-\x1F\x7F-\x9F]/g, "");
                    if (!fullText.trim()) throw new Error("ç„¡æ³•æå–æ–‡å­—ï¼Œå¯èƒ½æ˜¯åœ–ç‰‡æª”");
                    
                    setDmText(fullText);
                    
                    if (apiKey) {
                        const fabPrompt = `
                            ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ä¿éšªåˆ†æå¸«ã€‚è«‹é–±è®€ä»¥ä¸‹ä¿éšªå•†å“ DM å…§å®¹ã€‚
                            
                            ã€é‡è¦æŒ‡ä»¤ã€‘ï¼š
                            1. è«‹ä»¥ã€Œæ¨™æº– JSON æ ¼å¼ã€è¼¸å‡ºåˆ†æçµæœã€‚
                            2. JSON é–‹å§‹å‰èˆ‡çµæŸå¾Œã€Œä¸è¦ã€æœ‰ä»»ä½• Markdown æ¨™è¨˜ (å¦‚ \`\`\`json)ï¼Œåªçµ¦ç´” JSON å­—ä¸²ã€‚
                            3. ç¢ºä¿ JSON æ ¼å¼æ­£ç¢ºç„¡èª¤ï¼Œä¸è¦æœ‰å¤šé¤˜é€—è™Ÿã€‚

                            JSON çµæ§‹ï¼š
                            {
                                "productName": "å•†å“åç¨±",
                                "summary": "å•†å“ç°¡ä»‹ (200å­—å…§)",
                                "fabs": [
                                    {
                                        "feature": "ç‰¹è‰² (Feature)",
                                        "advantage": "å„ªå‹¢ (Advantage - ç”¨ç™½è©±æ–‡è§£é‡‹ç‚ºä»€éº¼é€™å€‹ç‰¹è‰²å¾ˆå¥½)",
                                        "benefit": "åˆ©ç›Š (Benefit - å°å®¢æˆ¶çš„å…·é«”å¥½è™•)"
                                    }
                                ]
                            }
                            
                            è¦æ±‚ï¼š
                            1. è«‹æ•´ç†å‡º 3 åˆ° 4 å€‹æœ€é‡è¦çš„ FABã€‚
                            2. æ¯å€‹æ¬„ä½å…§å®¹è«‹æ§åˆ¶åœ¨ 300 å­—ä»¥å…§ã€‚
                            3. ä½¿ç”¨å°ç£ç¹é«”ä¸­æ–‡ã€‚
                            
                            DM å…§å®¹ï¼š
                            ${fullText.substring(0, 20000)}
                        `;
                        
                        const responseText = await GeminiService.generateContent(apiKey, fabPrompt);
                        
                        // Robust JSON extraction
                        let cleanJson = responseText;
                        const jsonStart = responseText.indexOf('{');
                        const jsonEnd = responseText.lastIndexOf('}');
                        if (jsonStart !== -1 && jsonEnd !== -1) {
                            cleanJson = responseText.substring(jsonStart, jsonEnd + 1);
                        }

                        try {
                            const parsedData = JSON.parse(cleanJson);
                            setFabAnalysis(parsedData);
                            setChatHistory([{ role: 'ai', content: `æˆ‘å·²ç¶“åˆ†æå®Œ **${parsedData.productName || file.name}** çš„å…§å®¹å›‰ï¼\n\nå·¦å´æ˜¯å•†å“çš„ FAB é‡é»æ•´ç†ã€‚æ‚¨å¯ä»¥é¸æ“‡ä¸‹æ–¹çš„ã€Œç›®æ¨™å®¢ç¾¤ã€ä¾†ç”¢ç”Ÿå°ˆå±¬è©±è¡“ï¼Œæˆ–æ˜¯åœ¨é€™è£¡ç›´æ¥å•æˆ‘å•é¡Œã€‚` }]);
                        } catch (e) {
                            console.error("JSON Parse Error", e);
                            // Fallback for bad JSON
                            setFabAnalysis({ 
                                productName: file.name, 
                                summary: "AI å›å‚³çš„æ ¼å¼æœ‰é»å•é¡Œï¼Œç„¡æ³•è‡ªå‹•æ•´ç†æˆå¡ç‰‡ï¼Œä½†æˆ‘å·²ç¶“è®€æ‡‚å…§å®¹äº†ï¼Œæ‚¨å¯ä»¥ç›´æ¥åœ¨å³å´å°è©±æ¡†å•æˆ‘å•é¡Œï¼", 
                                fabs: [] 
                            });
                            setChatHistory([{ role: 'ai', content: `åˆ†æè³‡æ–™æ™‚ç™¼ç”Ÿæ ¼å¼éŒ¯èª¤ï¼Œä½†æˆ‘å·²ç¶“è®€éå…§å®¹äº†ã€‚æ‚¨å¯ä»¥ç›´æ¥å•æˆ‘å•é¡Œï¼` }]);
                        }

                    } else {
                        setChatHistory([{ role: 'ai', content: "è«‹å…ˆé»æ“Šå³ä¸Šè§’è¨­å®š API Keyï¼Œæˆ‘æ‰èƒ½å¹«æ‚¨åˆ†ææª”æ¡ˆå–”ï¼" }]);
                    }

                } catch (error) {
                    console.error(error);
                    setChatHistory([{ role: 'ai', content: `è§£æå¤±æ•—ï¼š${error.message}` }]);
                } finally {
                    setIsProcessingFile(false);
                }
            };

            const handleGenerateScript = async () => {
                if (!apiKey || !fabAnalysis) return;
                
                setIsGeneratingScript(true);
                const audienceMap = {
                    'family': 'å®¶åº­æ”¯æŸ± (ä¸Šæœ‰è€ä¸‹æœ‰å°ï¼Œæ“”å¿ƒè²¬ä»»æœªäº†)',
                    'single': 'å–®èº«è²´æ— (æ“”å¿ƒè€å¾Œç„¡äººç…§é¡§ï¼Œé†«ç™‚è‡ªè²»)',
                    'retiree': 'é€€ä¼‘æ—ç¾¤ (è³‡ç”¢å‚³æ‰¿ï¼Œé†«ç™‚å“è³ªï¼Œä¸æ‹–ç´¯å­å¥³)',
                    'business': 'ä¼æ¥­ä¸» (ç¨…å‹™è¦åŠƒï¼Œè³‡ç”¢ä¿å…¨)',
                    'newborn': 'æ–°ç”Ÿå…’çˆ¶æ¯ (æƒ³çµ¦å­©å­å®Œæ•´çš„èµ·è·‘é»)'
                };

                const scriptPrompt = `
                    è§’è‰²ï¼šé‡‘ç‰Œä¿éšªæ¥­å‹™å“¡
                    ä»»å‹™ï¼šæ’°å¯«ä¸€æ®µç´„è¨ª/é–‹é–€è©±è¡“ã€‚
                    
                    å•†å“ï¼š${fabAnalysis.productName}
                    å•†å“ç‰¹è‰²ï¼š${fabAnalysis.summary}
                    FABé‡é»ï¼š${JSON.stringify(fabAnalysis.fabs)}
                    
                    ç›®æ¨™å®¢æˆ¶ï¼š${audienceMap[targetAudience]}
                    
                    ã€çµ•å°åš´æ ¼çš„è¼¸å‡ºè¦å‰‡ã€‘ï¼š
                    1. **åªè¼¸å‡ºè©±è¡“å…§å®¹æœ¬èº«**ï¼Œä¸è¦æœ‰ä»»ä½•æ¨™é¡Œã€è§’è‰²èªªæ˜ã€æ‹¬è™Ÿå‚™è¨»æˆ– Markdown æ ¼å¼ã€‚
                    2. é–‹é ­ç›´æ¥è¬›è©±ï¼ˆä¾‹å¦‚ï¼šã€Œå¼µå…ˆç”Ÿä½ å¥½ï¼Œæˆ‘æœ€è¿‘çœ‹åˆ°...ã€ï¼‰ã€‚
                    3. å…§å®¹è¦é‡å°è©²å®¢æˆ¶é¡å‹çš„ç—›é»åˆ‡å…¥ï¼Œä¸¦é€£çµå•†å“å„ªå‹¢ã€‚
                    4. èªæ°£å°ˆæ¥­ã€è¦ªåˆ‡ã€å£èªåŒ– (å°ç£é¢¨æ ¼)ã€‚
                    5. çµå°¾è¦æœ‰æ˜ç¢ºçš„é‚€ç´„ã€‚
                    6. å­—æ•¸æ§åˆ¶åœ¨ 300 å­—ä»¥å…§ã€‚
                `;

                try {
                    const script = await GeminiService.generateContent(apiKey, scriptPrompt);
                    setGeneratedScript(script.trim());
                } catch (e) {
                    setGeneratedScript("ç”Ÿæˆè©±è¡“æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                } finally {
                    setIsGeneratingScript(false);
                }
            };

            useEffect(() => {
                if (fabAnalysis && apiKey) {
                    handleGenerateScript();
                }
            }, [fabAnalysis, targetAudience]);

            const handleSendMessage = async () => {
                if (!userInput.trim() || !apiKey) return;
                
                const userMsg = userInput;
                setUserInput('');
                setChatHistory(prev => [...prev, { role: 'user', content: userMsg }]);
                setIsChatLoading(true);

                try {
                    const prompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­ä¿éšªåŠ©ç†ã€‚æ ¹æ“šä»¥ä¸‹å•†å“è³‡æ–™å›ç­”å•é¡Œã€‚
                    
                    ã€å•†å“è³‡æ–™ã€‘ï¼š
                    ${dmText.substring(0, 25000)}

                    ã€ä½¿ç”¨è€…å•é¡Œã€‘ï¼š
                    ${userMsg}
                    
                    å›ç­”åŸå‰‡ï¼šå°ç£ç¹é«”ä¸­æ–‡ã€å°ˆæ¥­å£èªã€‚è‹¥è³‡æ–™æœªæåŠè«‹èª å¯¦å‘ŠçŸ¥ã€‚`;

                    const aiMsg = await GeminiService.generateContent(apiKey, prompt);
                    setChatHistory(prev => [...prev, { role: 'ai', content: aiMsg }]);

                } catch (error) {
                    setChatHistory(prev => [...prev, { role: 'ai', content: `éŒ¯èª¤ï¼š${error.message}` }]);
                } finally {
                    setIsChatLoading(false);
                }
            };

            return (
                <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-100px)]">
                    
                    {/* Left Column: Analysis & Script */}
                    <div className="lg:col-span-7 flex flex-col gap-6 h-full overflow-y-auto pr-2 pb-20">
                        
                        {/* File Upload */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <div 
                                onClick={() => fileInputRef.current.click()}
                                className="border-2 border-dashed border-blue-300 bg-blue-50 rounded-xl p-8 text-center cursor-pointer hover:bg-blue-100 transition-colors group"
                            >
                                <input type="file" ref={fileInputRef} className="hidden" accept=".pdf" onChange={handleFileUpload} />
                                <div className="flex flex-col items-center gap-3 text-blue-600 group-hover:text-blue-700">
                                    <Icons.Upload />
                                    <span className="font-bold text-lg">{fileName || "é»æ“Šä¸Šå‚³ä¿éšªå•†å“ DM (PDF)"}</span>
                                    <span className="text-sm opacity-75">AI å°‡è‡ªå‹•åˆ†æ FAB èˆ‡ç”Ÿæˆè©±è¡“</span>
                                </div>
                            </div>
                        </div>

                        {/* Loading State */}
                        {isProcessingFile && (
                            <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center justify-center py-12 animate-pulse">
                                <div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                                <p className="text-slate-500 font-medium">AI æ­£åœ¨é–±è®€æ¢æ¬¾ä¸¦æ•´ç† FAB ä¸­...</p>
                            </div>
                        )}

                        {/* FAB Analysis Result */}
                        {fabAnalysis && !isProcessingFile && (
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 fade-in">
                                <div className="flex items-center gap-2 mb-4 pb-2 border-b border-slate-100">
                                    <Icons.Sparkles />
                                    <h2 className="font-bold text-xl text-slate-800">å•†å“ FAB é‡é»åˆ†æ</h2>
                                </div>
                                
                                <div className="mb-6 bg-slate-50 p-4 rounded-lg text-slate-700 leading-relaxed text-sm">
                                    <span className="font-bold text-slate-900 block mb-1">å•†å“æ‘˜è¦ï¼š</span>
                                    {fabAnalysis.summary}
                                </div>

                                {fabAnalysis.fabs && fabAnalysis.fabs.length > 0 ? (
                                    <div className="space-y-4">
                                        {fabAnalysis.fabs.map((item, idx) => (
                                            <div key={idx} className="border border-slate-200 rounded-xl p-4 hover:shadow-md transition-shadow bg-white">
                                                <div className="flex gap-3">
                                                    <div className="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">{idx + 1}</div>
                                                    <div className="space-y-3 w-full">
                                                        <div>
                                                            <span className="text-xs font-bold text-blue-600 uppercase tracking-wide bg-blue-50 px-2 py-1 rounded">Feature ç‰¹è‰²</span>
                                                            <p className="font-bold text-slate-800 mt-1">{item.feature}</p>
                                                        </div>
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                            <div className="bg-slate-50 p-3 rounded-lg">
                                                                <span className="text-xs font-bold text-slate-500 block mb-1">Advantage å„ªå‹¢</span>
                                                                <p className="text-sm text-slate-600">{item.advantage}</p>
                                                            </div>
                                                            <div className="bg-green-50 p-3 rounded-lg">
                                                                <span className="text-xs font-bold text-green-600 block mb-1">Benefit åˆ©ç›Š</span>
                                                                <p className="text-sm text-slate-700 font-medium">{item.benefit}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center text-slate-500 py-4">æœªèƒ½è‡ªå‹•æå– FABï¼Œè«‹åƒè€ƒæ‘˜è¦æˆ–ç›´æ¥è©¢å• AIã€‚</div>
                                )}
                            </div>
                        )}

                        {/* Script Generator */}
                        {fabAnalysis && !isProcessingFile && (
                            <div className="bg-gradient-to-br from-indigo-50 to-white p-6 rounded-2xl shadow-sm border border-indigo-100 fade-in">
                                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                                    <h2 className="font-bold text-xl text-indigo-900 flex items-center gap-2">
                                        <Icons.Users /> åˆ†çœ¾è¡ŒéŠ·è©±è¡“
                                    </h2>
                                    
                                    <div className="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-indigo-200 shadow-sm w-full sm:w-auto">
                                        <span className="text-xs font-bold text-indigo-500 whitespace-nowrap">å°è±¡ï¼š</span>
                                        <select 
                                            value={targetAudience}
                                            onChange={(e) => setTargetAudience(e.target.value)}
                                            className="bg-transparent text-sm font-medium text-slate-700 outline-none cursor-pointer w-full"
                                        >
                                            <option value="family">å®¶åº­æ”¯æŸ±</option>
                                            <option value="single">å–®èº«è²´æ—</option>
                                            <option value="retiree">é€€ä¼‘æ—ç¾¤</option>
                                            <option value="business">ä¼æ¥­ä¸»</option>
                                            <option value="newborn">æ–°ç”Ÿå…’çˆ¶æ¯</option>
                                        </select>
                                    </div>
                                </div>

                                <div className="relative min-h-[150px]">
                                    {isGeneratingScript ? (
                                        <div className="absolute inset-0 flex items-center justify-center bg-white/50 backdrop-blur-sm rounded-xl z-10">
                                            <div className="typing-indicator"><span></span><span></span><span></span></div>
                                        </div>
                                    ) : null}
                                    
                                    <div className="bg-white p-5 rounded-xl border border-indigo-100 text-slate-700 leading-relaxed whitespace-pre-line shadow-sm">
                                        {generatedScript || "è«‹é¸æ“‡å®¢æˆ¶é¡å‹ä»¥ç”Ÿæˆè©±è¡“..."}
                                    </div>
                                </div>
                                
                                <div className="mt-3 flex justify-end">
                                    <button 
                                        onClick={() => navigator.clipboard.writeText(generatedScript)}
                                        className="text-xs flex items-center gap-1 text-indigo-600 hover:text-indigo-800 font-medium px-3 py-1 rounded hover:bg-indigo-50 transition-colors"
                                    >
                                        è¤‡è£½è©±è¡“
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Right Column: AI Chat */}
                    <div className="lg:col-span-5 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col h-full overflow-hidden sticky top-24">
                        <div className="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span className="font-bold text-slate-700">AI è«®è©¢å®¤</span>
                            </div>
                            {fileName && <span className="text-xs text-slate-400 truncate max-w-[120px]">{fileName}</span>}
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/30">
                            {chatHistory.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-slate-400 gap-3 opacity-60">
                                    <Icons.Robot />
                                    <p className="text-sm text-center">ä¸Šå‚³ DM å¾Œï¼Œ<br/>é€™è£¡å¯ä»¥å•æˆ‘ä»»ä½•æ¢æ¬¾ç´°ç¯€ã€‚</p>
                                </div>
                            ) : (
                                chatHistory.map((msg, idx) => (
                                    <div key={idx} className={`flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                                        <div className={`chat-bubble ${msg.role === 'user' ? 'chat-user' : 'chat-ai'}`}>
                                            {msg.role === 'ai' ? (
                                                <div className="prose prose-sm max-w-none dark:prose-invert" dangerouslySetInnerHTML={{ __html: md.render(msg.content) }} />
                                            ) : (
                                                msg.content
                                            )}
                                        </div>
                                    </div>
                                ))
                            )}
                            {isChatLoading && (
                                <div className="flex flex-col items-start">
                                    <div className="chat-bubble chat-ai">
                                        <div className="typing-indicator"><span></span><span></span><span></span></div>
                                    </div>
                                </div>
                            )}
                            <div ref={chatEndRef} />
                        </div>

                        <div className="p-3 bg-white border-t border-slate-100">
                            <div className="flex gap-2 relative">
                                <input 
                                    type="text" 
                                    className="flex-1 bg-slate-100 border-0 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none text-slate-800 placeholder-slate-400 text-sm"
                                    placeholder={apiKey ? "è¼¸å…¥å•é¡Œ..." : "è«‹å…ˆè¨­å®š API Key"}
                                    value={userInput}
                                    onChange={(e) => setUserInput(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleSendMessage()}
                                    disabled={!apiKey || isChatLoading}
                                />
                                <button 
                                    onClick={handleSendMessage}
                                    disabled={!apiKey || isChatLoading || !userInput.trim()}
                                    className="bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 text-white p-3 rounded-xl transition-all shadow-md active:scale-95"
                                >
                                    <Icons.Send />
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            );
        }

        // --- FEATURE 2: AI SMART PROPOSAL (With Auto-Scan & Validation) ---
        function SmartProposal({ apiKey }) {
            const [clientData, setClientData] = useState({ age: 30, gender: 'male', amount: 100, note: '', selectedTerm: '' });
            const [file, setFile] = useState(null);
            const [excelData, setExcelData] = useState('');
            const [aiResult, setAiResult] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isScanning, setIsScanning] = useState(false);
            const [constraints, setConstraints] = useState({ currency: 'å–®ä½', min: null, max: null, paymentTerms: [] });
            const fileRef = useRef(null);

            const handleFileChange = (e) => {
                const f = e.target.files[0];
                if (f) {
                    setFile(f);
                    setConstraints({ currency: 'å–®ä½', min: null, max: null, paymentTerms: [] }); // Reset
                    setClientData(prev => ({ ...prev, selectedTerm: '' }));
                    setIsScanning(true);
                    
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        try {
                            const bstr = evt.target.result;
                            const wb = XLSX.read(bstr, { type: 'binary' });
                            const wsname = wb.SheetNames[0];
                            const ws = wb.Sheets[wsname];
                            const csv = XLSX.utils.sheet_to_csv(ws);
                            const limitedCsv = csv.substring(0, 20000);
                            setExcelData(limitedCsv);
                            
                            if (apiKey) {
                                scanConstraints(limitedCsv, apiKey);
                            } else {
                                setIsScanning(false);
                            }
                        } catch (err) {
                            alert("Excel è®€å–å¤±æ•—");
                            setIsScanning(false);
                        }
                    };
                    reader.readAsBinaryString(f);
                }
            };

            const scanConstraints = async (csv, key) => {
                const prompt = `
                    è«‹åˆ†æä»¥ä¸‹ä¿éšªè²»ç‡è¡¨ CSV æ•¸æ“šï¼Œæ‰¾å‡ºï¼š
                    1. å¹£åˆ¥ (å°å¹£/ç¾å…ƒ/ç­‰)ã€‚
                    2. æŠ•ä¿ä¿é¡é™åˆ¶ (æœ€å°å€¼ Min, æœ€å¤§å€¼ Max)ã€‚å¦‚æœæ‰¾ä¸åˆ°æ˜ç¢ºé™åˆ¶ï¼Œè«‹æ ¹æ“šæ•¸æ“šæ¨æ¸¬åˆç†ç¯„åœ (ä¾‹å¦‚æ•¸æ“šéƒ½æ˜¯ 10000 èµ·è·³)ã€‚
                    3. ç¹³è²»å¹´æœŸé¸é … (ä¾‹å¦‚ï¼š6å¹´æœŸ, 10å¹´æœŸ, 20å¹´æœŸ, èº‰ç¹³)ã€‚è«‹åˆ—å‡ºæ‰€æœ‰åµæ¸¬åˆ°çš„å¹´æœŸã€‚å¦‚æœåªæœ‰ä¸€ç¨®ï¼Œå°±åˆ—å‡ºä¸€ç¨®ã€‚

                    è«‹å›å‚³ JSONï¼š
                    { 
                      "currency": "å–®ä½" (é è¨­) æˆ–åµæ¸¬åˆ°çš„å¹£åˆ¥, 
                      "min": æ•¸å­— (è‹¥ç„¡å‰‡ null), 
                      "max": æ•¸å­— (è‹¥ç„¡å‰‡ null),
                      "paymentTerms": ["6å¹´", "10å¹´"] (å­—ä¸²é™£åˆ—ï¼Œè‹¥ç„¡å‰‡ç©ºé™£åˆ—)
                    }
                    
                    CSV:
                    ${csv.substring(0, 5000)}
                `;
                try {
                    const res = await GeminiService.generateContent(key, prompt);
                    let clean = res.replace(/```json/g, '').replace(/```/g, '').trim();
                    const start = clean.indexOf('{');
                    const end = clean.lastIndexOf('}');
                    if (start !== -1 && end !== -1) clean = clean.substring(start, end+1);
                    
                    const data = JSON.parse(clean);
                    setConstraints({
                        currency: data.currency || 'å–®ä½',
                        min: data.min || 1,
                        max: data.max || 9999999,
                        paymentTerms: data.paymentTerms || []
                    });
                    // Auto select first term if only one
                    if (data.paymentTerms && data.paymentTerms.length === 1) {
                        setClientData(prev => ({ ...prev, selectedTerm: data.paymentTerms[0] }));
                    }
                } catch (e) {
                    console.log("Scan failed", e);
                } finally {
                    setIsScanning(false);
                }
            };

            const handleGenerate = async () => {
                if (!apiKey) return alert("è«‹å…ˆè¨­å®š API Key");
                if (!excelData && !file) return alert("è«‹ä¸Šå‚³å»ºè­°æ›¸ Excel æª”");
                
                setIsLoading(true);
                setAiResult('');

                const prompt = `
                    è§’è‰²ï¼šå°ˆæ¥­ä¿éšªè¡ŒéŠ·é¡§å•
                    ä»»å‹™ï¼šæ ¹æ“šæä¾›çš„è²»ç‡è¡¨æ•¸æ“šèˆ‡å®¢æˆ¶è³‡æ–™ï¼Œè£½ä½œä¸€ä»½ã€Œè¡ŒéŠ·å»ºè­°æ›¸å¡ç‰‡ã€ã€‚
                    
                    ã€å®¢æˆ¶è³‡æ–™ã€‘
                    - å¹´é½¡ï¼š${clientData.age} æ­²
                    - æ€§åˆ¥ï¼š${clientData.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'}
                    - ä¿é¡ï¼š${clientData.amount} ${constraints.currency}
                    - ç¹³è²»å¹´æœŸï¼š${clientData.selectedTerm || 'æœªæŒ‡å®š (è«‹AIåˆ¤æ–·)'}
                    - å‚™è¨»ï¼š${clientData.note || 'ç„¡'} (è‹¥æœ‰å‚™è¨»è«‹å‹™å¿…åœ¨åˆ†æä¸­å›æ‡‰)

                    ã€è²»ç‡è¡¨æ•¸æ“š (CSV)ã€‘
                    ${excelData}

                    â˜… åš´æ ¼æ’ç‰ˆè¦å‰‡ (é•åæœƒå°è‡´äº‚ç¢¼)ï¼š
                    1. ğŸš« çµ•å°ç¦æ­¢ä½¿ç”¨ LaTeX æ•¸å­¸èªæ³• (ç¦æ­¢å‡ºç¾ $$ æˆ– \\text ç­‰ç¬¦è™Ÿ)ã€‚
                    2. ğŸ”¢ æ‰€æœ‰æ•¸å­—è¨ˆç®—ç›´æ¥ç”¨æ–‡å­—è¡¨é”ï¼Œä¾‹å¦‚ï¼šã€Œ100è¬ x 0.02 = 2è¬å…ƒã€ã€‚
                    3. ğŸ¨ è«‹å¤§é‡ä½¿ç”¨ Emoji (ğŸ¯, ğŸ’°, âœ…) è®“ç‰ˆé¢æ´»æ½‘å¸ç›ã€‚
                    4. ğŸ“Š å‹™å¿…ä½¿ç”¨ Markdown è¡¨æ ¼å‘ˆç¾è©¦ç®—çµæœã€‚
                    5. ğŸ“ å…§å®¹è«‹ç²¾ç°¡ï¼Œä½¿ç”¨æ¢åˆ—å¼ (Bullet points)ï¼Œä¸è¦å¯«é•·ç¯‡å¤§è«–ã€‚

                    â˜… è¼¸å‡ºçµæ§‹ç¯„ä¾‹ï¼š
                    ### ğŸ¯ å°ˆå±¬è¦åŠƒæ–¹æ¡ˆ
                    (ä¸€å¥è©±å¸å¼•å®¢æˆ¶çš„æ¨™é¡Œ)

                    ### ğŸ’° ä¿è²»è©¦ç®—
                    | é …ç›® | å…§å®¹ |
                    | :--- | :--- |
                    | æŠ•ä¿å°è±¡ | ${clientData.age}æ­² ${clientData.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'} |
                    | è¦åŠƒå…§å®¹ | ${clientData.amount} ${constraints.currency} / ${clientData.selectedTerm || 'å¹´æœŸ'} |
                    | **é ä¼°å¹´ç¹³ä¿è²»** | **(è«‹æ ¹æ“šCSVæ•¸æ“šæ¨ç®—)** |

                    ### âœ… ç‚ºä»€éº¼é©åˆæ‚¨ï¼Ÿ
                    - (é»åˆ—å¼å„ªå‹¢ 1)
                    - (é»åˆ—å¼å„ªå‹¢ 2)
                    - (é»åˆ—å¼å„ªå‹¢ 3)

                    ### ğŸ“ é¡§å•è§€é»
                    (ä¸€æ®µæ„Ÿæ€§çš„çµå°¾ï¼Œç´„ 50-100 å­—)
                `;

                try {
                    const response = await GeminiService.generateContent(apiKey, prompt);
                    setAiResult(response);
                } catch (error) {
                    setAiResult(`ç”Ÿæˆå¤±æ•—ï¼š${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-120px)] overflow-hidden">
                    <div className="lg:col-span-1 flex flex-col gap-6 h-full overflow-y-auto pr-2 pb-20">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <h2 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Icons.Plan /> å»ºè­°æ›¸è¦åŠƒ</h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-600 mb-2">1. ä¸Šå‚³è²»ç‡è¡¨ (Excel)</label>
                                    <div onClick={() => fileRef.current.click()} className="border-2 border-dashed border-emerald-200 bg-emerald-50/50 rounded-xl p-4 text-center cursor-pointer hover:bg-emerald-50 relative">
                                        <input type="file" ref={fileRef} className="hidden" accept=".xlsx, .xls" onChange={handleFileChange} />
                                        <div className="text-emerald-600 flex flex-col items-center gap-1">
                                            {file ? <><Icons.CheckCircle /><span className="text-sm font-bold text-slate-700">{file.name}</span></> : <><Icons.Upload /><span className="text-xs">é»æ“Šä¸Šå‚³ Excel</span></>}
                                        </div>
                                        {isScanning && <div className="absolute inset-0 bg-white/80 flex items-center justify-center text-xs text-emerald-600 font-bold animate-pulse">AI æ­£åœ¨åˆ†æå¹£åˆ¥èˆ‡å¹´æœŸ...</div>}
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="block text-xs text-slate-500 mb-1">å¹´é½¡</label><input type="number" className="p-2 border rounded w-full" value={clientData.age} onChange={e => setClientData({...clientData, age: e.target.value})} /></div>
                                    <div><label className="block text-xs text-slate-500 mb-1">æ€§åˆ¥</label><select className="p-2 border rounded w-full" value={clientData.gender} onChange={e => setClientData({...clientData, gender: e.target.value})}><option value="male">ç”·æ€§</option><option value="female">å¥³æ€§</option></select></div>
                                </div>
                                
                                {/* Payment Term Selection */}
                                <div>
                                    <label className="block text-xs text-slate-500 mb-1">ç¹³è²»å¹´æœŸ</label>
                                    {constraints.paymentTerms.length > 1 ? (
                                        <select 
                                            className="p-2 border rounded w-full"
                                            value={clientData.selectedTerm}
                                            onChange={e => setClientData({...clientData, selectedTerm: e.target.value})}
                                        >
                                            <option value="">è«‹é¸æ“‡å¹´æœŸ</option>
                                            {constraints.paymentTerms.map(term => <option key={term} value={term}>{term}</option>)}
                                        </select>
                                    ) : constraints.paymentTerms.length === 1 ? (
                                        <input type="text" className="p-2 border rounded w-full bg-gray-100 text-slate-600" value={constraints.paymentTerms[0]} readOnly />
                                    ) : (
                                        <input 
                                            type="text" 
                                            className="p-2 border rounded w-full" 
                                            placeholder="ä¾‹å¦‚ï¼š20å¹´æœŸ"
                                            value={clientData.selectedTerm}
                                            onChange={e => setClientData({...clientData, selectedTerm: e.target.value})}
                                        />
                                    )}
                                </div>

                                <div>
                                    <label className="block text-xs text-slate-500 mb-1 flex justify-between">
                                        <span>ä¿é¡ ({constraints.currency})</span>
                                        {constraints.min && <span className="text-[10px] text-emerald-600">ç¯„åœ: {constraints.min}~{constraints.max}</span>}
                                    </label>
                                    <input 
                                        type="number" 
                                        className={`p-2 border rounded w-full ${constraints.min && (clientData.amount < constraints.min || clientData.amount > constraints.max) ? 'border-red-500 bg-red-50' : ''}`}
                                        value={clientData.amount} 
                                        onChange={e => setClientData({...clientData, amount: e.target.value})}
                                    />
                                </div>
                                <div><label className="block text-xs text-slate-500 mb-1">å‚™è¨»</label><textarea className="p-2 border rounded w-full h-20" value={clientData.note} onChange={e => setClientData({...clientData, note: e.target.value})}></textarea></div>
                                <button onClick={handleGenerate} disabled={isLoading || !file || (constraints.min && (clientData.amount < constraints.min || clientData.amount > constraints.max))} className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 transition-all disabled:bg-slate-300 disabled:cursor-not-allowed">
                                    {isLoading ? "AI è¦åŠƒä¸­..." : "é–‹å§‹ç”Ÿæˆå»ºè­°æ›¸"}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div className="lg:col-span-2 h-full overflow-y-auto pb-20">
                        <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 min-h-[400px]">
                            {aiResult ? (
                                <div className="prose prose-slate max-w-none fade-in">
                                    <div dangerouslySetInnerHTML={{ __html: md.render(aiResult) }}></div>
                                </div>
                            ) : (
                                <div className="h-full flex flex-col items-center justify-center text-slate-400 gap-4 opacity-60 min-h-[300px]">
                                    <Icons.Calculator />
                                    <p className="text-center">è«‹ä¸Šå‚³ Excel ä¸¦è¼¸å…¥è³‡æ–™ï¼Œ<br/>AI å°‡ç‚ºæ‚¨ç”Ÿæˆç²¾ç¾çš„è¡ŒéŠ·å»ºè­°æ›¸ã€‚</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
